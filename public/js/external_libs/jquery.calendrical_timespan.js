timely.define(["jquery_timely"],function(e){function o(){var e=new Date;return new Date(e.getFullYear(),e.getMonth(),e.getDate())}function u(e,t){return typeof e=="string"&&(e=new Date(e)),typeof t=="string"&&(t=new Date(t)),e.getUTCDate()===t.getUTCDate()&&e.getUTCMonth()===t.getUTCMonth()&&e.getUTCFullYear()===t.getUTCFullYear()?!0:!1}function a(e,t){if(e instanceof Date)return a(e.getUTCFullYear(),e.getUTCMonth());if(t==1){var n=e%4==0&&(e%100!=0||e%400==0);return n?29:28}return t==3||t==5||t==8||t==10?30:31}function f(e){return new Date(e.getTime()+864e5)}function l(e){return new Date(e.getTime()-864e5)}function c(e,t){return t==11?new Date(e+1,0,1):new Date(e,t+1,1)}function h(t,n,r,i){var s=i.monthNames.split(","),o=e("<thead />"),u=e("<tr />").appendTo(o);e("<th />").addClass("monthCell").append(e('<a href="javascript:;">&laquo;</a>').addClass("prevMonth").mousedown(function(e){p(t,r==0?n-1:n,r==0?11:r-1,i),e.preventDefault()})).appendTo(u),e("<th />").addClass("monthCell").attr("colSpan",5).append(e('<a href="javascript:;">'+s[r]+" "+n+"</a>").addClass("monthName")).appendTo(u),e("<th />").addClass("monthCell").append(e('<a href="javascript:;">&raquo;</a>').addClass("nextMonth").mousedown(function(){p(t,r==11?n+1:n,r==11?0:r+1,i)})).appendTo(u);var a=i.dayNames.split(","),f=parseInt(i.weekStartDay),l=[];for(var c=0,h=a.length;c<h;c++)l[c]=a[(c+f)%h];var d=e("<tr />").appendTo(o);return e.each(l,function(t,n){e("<td />").addClass("dayName").append(n).appendTo(d)}),o}function p(t,n,r,i){i=i||{};var s=parseInt(i.weekStartDay),a=i.today?i.today:o();a.setHours(0),a.setMinutes(0);var p=new Date(n,r,1),d=c(n,r),v=Math.abs(a.getTimezoneOffset());v!=0&&(a.setHours(a.getHours()+v/60),a.setMinutes(a.getMinutes()+v%60),p.setHours(p.getHours()+v/60),p.setMinutes(p.getMinutes()+v%60),d.setHours(d.getHours()+v/60),d.setMinutes(d.getMinutes()+v%60));var m=d.getUTCDay()-s;m<0?m=Math.abs(m)-1:m=6-m;for(var g=0;g<m;g++)d=f(d);var y=e("<table />");h(t,n,r,i).appendTo(y);var b=e("<tbody />").appendTo(y),w=e("<tr />"),E=p.getUTCDay()-s;E<0&&(E=7+E);for(var g=0;g<E;g++)p=l(p);while(p<=d){var S=e("<td />").addClass("day").append(e('<a href="javascript:;">'+p.getUTCDate()+"</a>").click(function(){var e=p;return function(){i&&i.selectDate&&i.selectDate(e)}}())).appendTo(w),x=u(p,a),T=i.selected&&u(i.selected,p);x&&S.addClass("today"),T&&S.addClass("selected"),x&&T&&S.addClass("today_selected"),p.getUTCMonth()!=r&&S.addClass("nonMonth");var N=p.getUTCDay();(N+1)%7==s&&(b.append(w),w=e("<tr />")),p=f(p)}w.children().length?b.append(w):w.remove(),t.empty().append(y)}function d(t,n){var i=n.selection&&s(n.selection);i&&(i.minute=Math.floor(i.minute/15)*15);var o=n.startTime&&n.startTime.hour*60+n.startTime.minute,u,a=e("<ul />");for(var f=0;f<24;f++)for(var l=0;l<60;l+=15){if(o&&o>f*60+l)continue;(function(){var t=r(f,l,n.isoTime),s=t;if(o!=null){var c=f*60+l-o;c<60?s+=" ("+c+" min)":c==60?s+=" (1 hr)":s+=" ("+Math.floor(c/60)+" hr "+c%60+" min)"}var h=e("<li />").append(e('<a href="javascript:;">'+s+"</a>").click(function(){n&&n.selectTime&&n.selectTime(t)}).mousemove(function(){e("li.selected",a).removeClass("selected")})).appendTo(a);!u&&f==n.defaultHour&&(u=h),i&&i.hour==f&&i.minute==l&&(h.addClass("selected"),u=h)})()}u&&setTimeout(function(){t[0].scrollTop=u[0].offsetTop-u.height()*2},0),t.empty().append(a)}function v(e){e.addClass("error").fadeOut("normal",function(){e.val(e.data("timespan.stored")).removeClass("error").fadeIn("fast")})}function m(){e(this).data("timespan.stored",this.value)}function g(t,i,s,o,u,a,f,l,c,h){s.val(s.data("timespan.initial_value")),a.val(a.data("timespan.initial_value")),f.get(0).checked=f.data("timespan.initial_value");var p=parseInt(s.val());isNaN(parseInt(p))?(p=new Date(h),i.val(r(p.getUTCHours(),p.getUTCMinutes()-p.getUTCMinutes()%15,l))):(p=new Date(parseInt(p)*1e3),i.val(r(p.getUTCHours(),p.getUTCMinutes(),l))),t.val(n(p,c));var d=parseInt(a.val());isNaN(parseInt(d))?(d=new Date(p.getTime()+36e5),u.val(r(d.getUTCHours(),d.getUTCMinutes()-d.getUTCMinutes()%15,l))):(d=new Date(parseInt(d)*1e3),u.val(r(d.getUTCHours(),d.getUTCMinutes(),l))),f.get(0).checked&&d.setUTCDate(d.getUTCDate()-1),o.val(n(d,c)),t.each(m),i.each(m),o.each(m),u.each(m),f.trigger("change.timespan"),e("#ai1ec_instant_event").trigger("change.timespan")}var t={us:{pattern:/([\d]{1,2})\/([\d]{1,2})\/([\d]{4}|[\d]{2})/,format:"m/d/y",order:"middleEndian",zeroPad:!1},iso:{pattern:/([\d]{4}|[\d]{2})-([\d]{1,2})-([\d]{1,2})/,format:"y-m-d",order:"bigEndian",zeroPad:!0},dot:{pattern:/([\d]{1,2}).([\d]{1,2}).([\d]{4}|[\d]{2})/,format:"d.m.y",order:"littleEndian",zeroPad:!1},def:{pattern:/([\d]{1,2})\/([\d]{1,2})\/([\d]{4}|[\d]{2})/,format:"d/m/y",order:"littleEndian",zeroPad:!1}},n=function(e,n,r){var i,s,o;typeof t[n]=="undefined"&&(n="def"),typeof r=="undefined"&&(r=!1),!0===r?(i=e.getFullYear().toString(),s=(e.getMonth()+1).toString(),o=e.getDate().toString()):(i=e.getUTCFullYear().toString(),s=(e.getUTCMonth()+1).toString(),o=e.getUTCDate().toString()),t[n].zeroPad&&(s.length==1&&(s="0"+s),o.length==1&&(o="0"+o));var u=t[n].format;return u=u.replace("d",o),u=u.replace("m",s),u=u.replace("y",i),u},r=function(e,t,n){var r=t;t<10&&(r="0"+t);if(n){var i=e;return i<10&&(i="0"+e),i+":"+r}var i=e%12;i==0&&(i=12);var s=e<12?"am":"pm";return i+":"+r+s},i=function(e,n){typeof t[n]=="undefined"&&(n="def");var r=e.match(t[n].pattern);if(!r||r.length!=4)return Date("invalid");switch(t[n].order){case"bigEndian":var i=r[3],s=r[2],o=r[1];break;case"littleEndian":var i=r[1],s=r[2],o=r[3];break;case"middleEndian":var i=r[2],s=r[1],o=r[3];break;default:var i=r[1],s=r[2],o=r[3]}return o.length==2&&(o=(new Date).getUTCFullYear().toString().substr(0,2)+o),new Date(s+"/"+i+"/"+o+" GMT")},s=function(e){var t=t=/(\d+)\s*[:\-\.,]\s*(\d+)\s*(am|pm)?/i.exec(e);if(t&&t.length>=3){var n=Number(t[1]),r=Number(t[2]);return n==12&&t[3]&&(n-=12),t[3]&&t[3].toLowerCase()=="pm"&&(n+=12),{hour:n,minute:r}}return null};e.fn.calendricalDate=function(t){return t=t||{},t.padding=t.padding||4,t.monthNames=t.monthNames||"January,February,March,April,May,June,July,August,September,October,November,December",t.dayNames=t.dayNames||"S,M,T,W,T,F,S",t.weekStartDay=t.weekStartDay||0,this.each(function(){var r=e(this),s,u=!1;r.bind("focus",function(){if(s)return;var a=r.position(),f=r.css("padding-left");s=e("<div />").addClass("calendricalDatePopup").mouseenter(function(){u=!0}).mouseleave(function(){u=!1}).mousedown(function(e){e.preventDefault()}).css({position:"absolute",left:a.left,top:a.top+r.height()+t.padding*2}),r.after(s);var l=i(r.val(),t.dateFormat);l.getUTCFullYear()||(l=t.today?t.today:o()),p(s,l.getUTCFullYear(),l.getUTCMonth(),{today:t.today,selected:l,monthNames:t.monthNames,dayNames:t.dayNames,weekStartDay:t.weekStartDay,selectDate:function(e){u=!1,r.val(n(e,t.dateFormat)),s.remove(),s=null;if(t.endDate){var o=i(t.endDate.val(),t.dateFormat);o>=l&&t.endDate.val(n(new Date(e.getTime()+o.getTime()-l.getTime()),t.dateFormat))}}})}).blur(function(){if(u){s&&r.focus();return}if(!s)return;s.remove(),s=null})})},e.fn.calendricalDateRange=function(t){return this.length>=2&&(e(this[0]).calendricalDate(e.extend({endDate:e(this[1])},t)),e(this[1]).calendricalDate(t)),this},e.fn.calendricalDateRangeSingle=function(t){return this.length==1&&e(this).calendricalDate(t),this},e.fn.calendricalTime=function(t){return t=t||{},t.padding=t.padding||4,this.each(function(){var n=e(this),r,o=!1;n.bind("focus click",function(){if(r)return;var a=t.startTime;a&&t.startDate&&t.endDate&&!u(i(t.startDate.val()),i(t.endDate.val()))&&(a=!1);var f=n.position();r=e("<div />").addClass("calendricalTimePopup").mouseenter(function(){o=!0}).mouseleave(function(){o=!1}).mousedown(function(e){e.preventDefault()}).css({position:"absolute",left:f.left,top:f.top+n.height()+t.padding*2}),a&&r.addClass("calendricalEndTimePopup"),n.after(r);var l={selection:n.val(),selectTime:function(e){o=!1,n.val(e),r.remove(),r=null},isoTime:t.isoTime||!1,defaultHour:t.defaultHour!=null?t.defaultHour:8};a&&(l.startTime=s(t.startTime.val())),d(r,l)}).blur(function(){if(o){r&&n.focus();return}if(!r)return;r.remove(),r=null})})},e.fn.calendricalTimeRange=function(t){return this.length>=2&&(e(this[0]).calendricalTime(t),e(this[1]).calendricalTime(e.extend({startTime:e(this[0])},t))),this},e.fn.calendricalDateTimeRange=function(t){return this.length>=4&&(e(this[0]).calendricalDate(e.extend({endDate:e(this[2])},t)),e(this[1]).calendricalTime(t),e(this[2]).calendricalDate(t),e(this[3]).calendricalTime(e.extend({startTime:e(this[1]),startDate:e(this[0]),endDate:e(this[2])},t))),this};var y={allday:"#allday",start_date_input:"#start-date-input",start_time_input:"#start-time-input",start_time:"#start-time",end_date_input:"#end-date-input",end_time_input:"#end-time-input",end_time:"#end-time",twentyfour_hour:!1,date_format:"def",now:new Date},b={init:function(t){function N(){var e=i(a.val(),o.date_format).getTime()/1e3,t=s(f.val());e+=t.hour*3600+t.minute*60;var n=i(c.val(),o.date_format).getTime()/1e3,r=s(h.val());return n+=r.hour*3600+r.minute*60,n-e}function C(){var e=i(a.data("timespan.stored"),o.date_format),t=s(f.data("timespan.stored")),u=e.getTime()/1e3+t.hour*3600+t.minute*60+a.data("time_diff");return u=new Date(u*1e3),c.val(n(u,o.date_format)),h.val(r(u.getUTCHours(),u.getUTCMinutes(),o.twentyfour_hour)),!0}var o=e.extend({},y,t),u=e(o.allday),a=e(o.start_date_input),f=e(o.start_time_input),l=e(o.start_time),c=e(o.end_date_input),h=e(o.end_time_input),p=e(o.end_time),d=e("#ai1ec_instant_event"),b=c.add(h),w=a.add(o.end_date_input),E=f.add(o.end_time_input),S=a.add(o.start_time_input).add(o.end_date_input).add(o.end_time_input);S.bind("focus.timespan",m),d.bind("change.timespan",function(){this.checked?(b.closest("tr").fadeOut(),u.attr("disabled",!0)):(u.removeAttr("disabled"),b.closest("tr").fadeIn())});var x=new Date(o.now.getFullYear(),o.now.getMonth(),o.now.getDate()),T=!1;return u.bind("change.timespan",function(){this.checked?(E.fadeOut(),d.attr("disabled",!0)):(d.removeAttr("disabled"),E.fadeIn()),T||(T=!0,S.calendricalDateTimeRange({today:x,dateFormat:o.date_format,isoTime:o.twentyfour_hour,monthNames:o.month_names,dayNames:o.day_names,weekStartDay:o.week_start_day}))}).get().checked=!1,w.bind("blur.timespan",function(){var t=i(this.value,o.date_format);isNaN(t)?v(e(this)):(e(this).data("timespan.stored",this.value),e(this).val(n(t,o.date_format)))}),E.bind("blur.timespan",function(){var t=s(this.value);t?(e(this).data("timespan.stored",this.value),e(this).val(r(t.hour,t.minute,o.twentyfour_hour))):v(e(this))}),a.add(o.start_time_input).bind("focus.timespan",function(){a.data("time_diff",N())}).bind("blur.timespan",function(){a.data("time_diff")<0&&a.data("time_diff",900);var e=C()}),c.add(o.start_time_input).bind("blur.timespan",function(){if(N()<0){a.data("time_diff",900);var e=C()}}),a.closest("form").bind("submit.timespan",function(){var e=i(a.val(),o.date_format).getTime()/1e3;if(!isNaN(e)){if(!u.get(0).checked){var t=s(f.val());t?e+=t.hour*3600+t.minute*60:e=""}}else e="";l.val(e);var n=i(c.val(),o.date_format).getTime()/1e3;if(!isNaN(n))if(u.get(0).checked)n+=86400;else{var t=s(h.val());t?n+=t.hour*3600+t.minute*60:n=""}else n="";p.val(n)}),l.data("timespan.initial_value",l.val()),p.data("timespan.initial_value",p.val()),u.data("timespan.initial_value",u.get(0).checked),g(a,f,l,c,h,p,u,o.twentyfour_hour,o.date_format,o.now),this},reset:function(t){var n=e.extend({},y,t);return g(e(n.start_date_input),e(n.start_time_input),e(n.start_time),e(n.end_date_input),e(n.end_time_input),e(n.end_time),e(n.allday),n.twentyfour_hour,n.date_format,n.now),this},destroy:function(t){return t=e.extend({},y,t),e.each(t,function(t,n){e(n).unbind(".timespan")}),e(t.start_date_input).closest("form").unbind(".timespan"),this}};return e.timespan=function(t){if(b[t])return b[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t=="object"||!t)return b.init.apply(this,arguments);e.error("Method "+t+" does not exist on jQuery.timespan")},{formatDate:n,parseDate:i}});