timely.define(["jquery_timely","scripts/calendar/print","scripts/calendar/agenda_view","scripts/calendar/month_view","libs/frontend_utils","libs/utils","ai1ec_calendar","ai1ec_config","scripts/common_scripts/frontend/common_frontend","libs/select2_multiselect_helper","external_libs/twig","twigjs/agenda","twigjs/oneday","external_libs/jquery_history","external_libs/jquery.tablescroller","external_libs/jquery.scrollTo","external_libs/bootstrap_datepicker","external_libs/bootstrap/alert","external_libs/jquery_cookie"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){e.cookie.json=!0;var p="ai1ec_saved_filter",d=!e("#save_filtered_views").hasClass("ai1ec-hide"),v=function(e){var t=e.find("#ai1ec-view-dropdown .ai1ec-dropdown-menu .ai1ec-active a"),n=u.week_view_ends_at-u.week_view_starts_at,i=n*60;e.find("table.ai1ec-week-view-original").tableScroll({height:i,containerClass:"ai1ec-week-view ai1ec-popover-boundary",scroll:!1}),e.find("table.ai1ec-oneday-view-original").tableScroll({height:i,containerClass:"ai1ec-oneday-view ai1ec-popover-boundary",scroll:!1});if(e.find(".ai1ec-week-view").length||e.find(".ai1ec-oneday-view").length)e.find(".ai1ec-oneday-view .tablescroll_wrapper, .ai1ec-week-view .tablescroll_wrapper").scrollTo(e.find(".ai1ec-hour-marker:eq("+u.week_view_starts_at+")")),e.find(".ai1ec-hour-marker:eq("+u.week_view_starts_at+")").addClass("ai1ec-first-visible");e.find(".ai1ec-month-view .ai1ec-multiday").length&&r.extend_multiday_events(e),e.find(".ai1ec-calendar-view-container").trigger("initialize_view.ai1ec"),e.find(".ai1ec-calendar-toolbar").trigger("ai1ec-affix.reinit")},m=function(t){t.find(".ai1ec-calendar-view-container").trigger("destroy_view.ai1ec");var n=t.find(".ai1ec-minical-trigger").data("datepicker");typeof n!="undefined"&&(n.picker.remove(),e(document).off("changeDate",".ai1ec-minical-trigger")),t.find(".ai1ec-tooltip.ai1ec-in, .ai1ec-popup").remove(),t.find(".ai1ec-calendar-toolbar .ai1ec-btn-toolbar").remove()},g=function(){var t=[],n=[],r=[],i;e(".ai1ec-category-filter .ai1ec-dropdown-menu .ai1ec-active").each(function(){t.push(e(this).data("term"))}),e(".ai1ec-tag-filter .ai1ec-dropdown-menu .ai1ec-active").each(function(){n.push(e(this).data("term"))}),e(".ai1ec-author-filter .ai1ec-dropdown-menu .ai1ec-active").each(function(){r.push(e(this).data("term"))});var s={};return s.cat_ids=t,s.tag_ids=n,s.auth_ids=r,i=e(".ai1ec-views-dropdown .ai1ec-dropdown-menu .ai1ec-active").data("action"),s.action=i,s},y=function(){var t=History.getState(),n=e.cookie(p);if(null===n||undefined===n)n={};var r=g();u.is_calendar_page?n.calendar_page=r:n[t.url]=r,e.cookie(p,n,{path:"/",expires:365}),e("#save_filtered_views").addClass("ai1ec-active").attr("data-original-title",u.clear_saved_filter_text);var i=s.make_alert(u.save_filter_text_ok,"success");e("#ai1ec-calendar").prepend(i)},b=function(t){t.stopImmediatePropagation();var n=e.cookie(p);if(u.is_calendar_page)delete n.calendar_page;else{var r=History.getState();delete n[r.url]}e.cookie(p,n,{path:"/",expires:365}),e("#save_filtered_views").removeClass("ai1ec-active").attr("data-original-title",u.reset_saved_filter_text),d||e("#save_filtered_views").addClass("ai1ec-hide");var i=s.make_alert(u.remove_filter_text_ok,"success");e("#ai1ec-calendar").prepend(i)},w=function(t,n,r){t.find(".ai1ec-calendar-view-loading").fadeIn("fast").end().find(".ai1ec-calendar-view").fadeTo("fast",.3,function(){var i={request_type:r,ai1ec_doing_ajax:!0};e.ajax({url:n,dataType:r,data:i,method:"get",success:function(r){e(".ai1ec-subscribe-container").show(),m(t),typeof r.views_dropdown=="string"&&t.find(".ai1ec-views-dropdown").replaceWith(r.views_dropdown),typeof r.categories=="string"&&t.find(".ai1ec-category-filter").replaceWith(r.categories),typeof r.authors=="string"&&t.find(".ai1ec-author-filter").replaceWith(r.authors),typeof r.tags=="string"&&t.find(".ai1ec-tag-filter").replaceWith(r.tags),typeof r.custom_filters=="string"&&($parent=t.find("li.ai1ec-custom-filter").parent(),t.find("li.ai1ec-custom-filter").remove(),$parent.append(r.custom_filters)),typeof r.subscribe_buttons=="string"&&t.find(".ai1ec-subscribe-container").replaceWith(r.subscribe_buttons),typeof r.save_view_btngroup=="string"&&t.find("#save_filtered_views").closest(".ai1ec-btn-group").replaceWith(r.save_view_btngroup),d=r.are_filters_set;var i=t.find(".ai1ec-calendar-view-container");i.height(i.height());var s;if(n.match(/request_format\~json/)){var o=e.parseJSON(r.html).type;"agenda"===o&&(s=c),"oneday"===o&&(s=h)}t.find(".ai1ec-calendar-view").html(s?s.render(e.parseJSON(r.html)):r.html);var u=t.find(".ai1ec-calendar-view").height();i.animate({height:u},{complete:function(){i.height("auto")}}),t.find(".ai1ec-calendar-view-loading").fadeOut("fast"),t.find(".ai1ec-calendar-view").fadeTo("fast",1),v(t)}})})},E=!1,S=function(t){var n=History.getState(),r=e(".ai1ec-calendar:first");if(n.data.ai1ec!==undefined&&!0===n.data.ai1ec||!0===E)E=!0,w(r,n.url,"json")},x=function(e,t,n){if(t==="json"){var r={ai1ec:!0};History.pushState(r,document.title,decodeURI(n))}else w(e,n,"jsonp")},T=function(t){var n=e(this);$calendar=n.closest(".ai1ec-calendar"),t.preventDefault(),x($calendar,n.data("type"),n.attr("href"))},N=function(t){var n=e(this);t.preventDefault();if(typeof n.data("datepicker")=="undefined"){n.datepicker({todayBtn:"linked",todayHighlight:!0,language:n.data("lang")});var r=n.data("datepicker");if(n.closest(".ai1ec-pull-right").length>0){r.picker.addClass("ai1ec-right-aligned");var i=r.place;r.place=function(){i.call(this);var t=this.component?this.component:this.element,n=t.offset();this.picker.css({left:"auto",right:e(document).width()-n.left-t.outerWidth()})}}e(document).on("changeDate",".ai1ec-minical-trigger",C)}n.datepicker("show")},C=function(t){var n,r=e(this),i=r.closest(".ai1ec-calendar"),s;r.datepicker("hide"),n=r.data("href"),s=t.format(),s=s.replace(/\//g,"-"),n=n.replace("__DATE__",s),x(i,r.data("type"),n)},k=function(t){var n;typeof t.added!="undefined"?n=e(t.added.element).data("href"):n=e("option[value="+t.removed.id+"]",t.target).data("href"),data={ai1ec:!0},History.pushState(data,null,n)},L=function(){var t=e(this).closest(".ai1ec-calendar");x(t,e(this).data("type"),e(this).data("href"))};return{initialize_view:v,handle_click_on_link_to_load_view:T,handle_minical_trigger:N,handle_minical_change_date:C,clear_filters:L,handle_state_change:S,load_view:w,save_current_filter:y,remove_current_filter:b,load_view_from_select2_filter:k,load_view_according_to_datatype:x}});